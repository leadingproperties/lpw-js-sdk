/* @version 1.0.0 | @license MIT */
!function(t){"use strict";function e(t){this.token=t,this.apiPath="https://lpw-public-api.herokuapp.com"}function o(){}function r(t,r){this.locale=r&&r.locale||"en",this.debugEnabled=r&&r.debugEnabled||!1,this.connector=new e(t),this.helper=new o,this.logger=new n(this.debugEnabled),this.optionsParser=new i(this.helper,this.logger),l=new s(this.connector)}function n(t){this.enabled=t||!1}function i(t,e){this.helper=t,this.logger=e}function s(t){this.attemptsMax=20,this.attempt=0,this.delay=1e3,this.timeoutID=void 0,this.connector=t}e.prototype.readProperties=function(t,e){var o=this.apiPath+"/property_objects";"string"==typeof t&&t.length>0&&(o=o+"?"+t),this._defaultRequest(o,"GET",null,e)},e.prototype.readPropertyById=function(t,e,o){this._defaultRequest(this.apiPath+"/property_objects/"+t+"?locale="+e,"GET",null,o)},e.prototype.readCurrencies=function(t){this._defaultRequest(this.apiPath+"/currencies","GET",null,t)},e.prototype.readPDF=function(t,e,o,r){this._defaultRequest(this.apiPath+"/"+o+"/pdf/"+t+(e?"?for_rent=true":""),"GET",null,r)},e.prototype.readTotalCounters=function(t){this._defaultRequest(this.apiPath+"/counters/global","GET",null,t)},e.prototype.readGeoPionts=function(t,e){this._defaultRequest(this.apiPath+"/property_objects/"+t,"GET",null,e)},e.prototype._defaultRequest=function(t,e,o,r){var n=new XMLHttpRequest;if(e=e||"GET",n.open(e,t,!0),n.setRequestHeader("Authorization","Token token="+this.token),o)for(var i in o)n.setRequestHeader(i,o[i]);n.onload=r.bind(this,n),n.onerror=r.bind(this,n),n.send(null)},o.prototype.isSuccessHTTPStatus=function(t){return t>=200&&t<400},o.prototype.getTransformedResponse=function(t,e){return{data:t||null,status:e?e.status:0,statusText:e?e.statusText:""}},o.prototype.isArray=function(t){return"object"==typeof t&&t instanceof Array&&"[object Array]"===Object.prototype.toString.call(t)},o.prototype.isObject=function(t){return t===Object(t)&&"[object Array]"!==Object.prototype.toString.call(t)},o.prototype.cleanObject=function(t){if(!this.isObject(t))return t;for(var e in t)!t.hasOwnProperty(e)||null!==t[e]&&void 0!==t[e]||delete t[e];return t};var l;r.prototype.getProperties=function(t,e){if(!e||"function"!=typeof e)throw new TypeError("LPW.getProperties: callback is not a function");this.helper.isObject(t)||(t={}),t.locale||(t.locale=this.locale),this.connector.readProperties(this.optionsParser.getSerializedOptions(t),this.defaultCallback.bind(this,e))},r.prototype.getPropertyById=function(t,e,o){if(t=parseInt(t,10),"function"!=typeof o)throw new TypeError("LPW.getPropertyById: callback is not a function");if(isNaN(t))throw new TypeError("LPW.getPropertyById: ID is not a number");this.helper.isObject(e)||(e={}),e.locale||(e.locale=this.locale),this.connector.readPropertyById(t,e.locale,this.defaultCallback.bind(this,o))},r.prototype.getCurrencies=function(t){this.connector.readCurrencies(this.defaultCallback.bind(this,t))},r.prototype.setLocale=function(t){if("string"!=typeof t)throw new TypeError("LPW.setLocale: locale is not a string");this.locale=t},r.prototype.getPDF=function(t,e,o){if(t=parseInt(t,10),"function"!=typeof o)throw new TypeError("LPW.getPDF: callback is not a function");if(isNaN(t))throw new TypeError("LPW.getPDF: ID is not a number");var r={};r.forRent=e.forRent||null,r.locale=e.locale||this.locale,l.requestPDF(t,r.forRent,r.locale,this.getPDFCallback.bind(this,o))},r.prototype.getTotalCounters=function(t){if("function"!=typeof t)throw new TypeError("LPW.getPDF: callback is not a function");this.connector.readTotalCounters(this.defaultCallback.bind(this,t))},r.prototype.getGeoPoints=function(t,e){if("function"!=typeof e)throw new TypeError("LPW.getPDF: callback is not a function");"sale"===t&&"sale"===t&&"commercial"===t||this.logger.log('LPW.getGeoPoints: type is not one of: "sale", "rent" or "commercial". "sale" used by default.');var o;switch(t){case"rent":o="rent_geo_points";break;case"commercial":o="invest_geo_points";break;default:o="geo_points"}this.connector.readGeoPionts(o,this.defaultCallback.bind(this,e))},r.prototype.defaultCallback=function(t,e){var o=this.helper.isSuccessHTTPStatus(e.status)?JSON.parse(e.response):null,r=this.helper.getTransformedResponse(o,e);t(r)},r.prototype.getPDFCallback=function(t,e){var o=e&&this.helper.isSuccessHTTPStatus(e.status)?JSON.parse(e.response):null,r=this.helper.getTransformedResponse(o,e?e:{status:408,statusText:"Request Timeout"});t(r)},t.LPW=r,n.prototype.log=function(t){this.enabled&&console.log(t)},n.prototype.logError=function(){},i.prototype.getParsedOptions=function(t){var e=this,o={id:t.id||null,locale:t.locale||"en",page:t.page||1,per_page:t.perPage||10,for_sale:!t.forRent,for_rent:!!t.forRent,order_by:t.orderBy?{order:t.orderBy}:null,location_point:t.locationPoint?e._getParsedLocationPoint(t.locationPoint):null,location_shape:t.locationShape?e._getParsedLocationShape(t.locationShape):null,hd_photos:t.hdPhotos||null,area:t.area?e._getParsedArea(t.area):null,price:t.price?e._getParsedPrice(t.price,t.forRent):null,property_types:t.propertyTypes&&e.helper.isArray(t.propertyTypes)?t.propertyTypes:null,rooms:t.rooms&&e.helper.isArray(t.rooms)?t.rooms:null,ids:t.ids&&e.helper.isArray(t.ids)?t.ids:null};return o.for_rent&&(o.child_friendly=o.for_rent&&t.childFriendly||null,o.pets_allowed=o.for_rent&&t.petsAllowed||null,o.long_rent=o.for_rent&&t.longRent||null,o.short_rent=o.for_rent&&t.shortRent||null,o.persons=o.for_rent?t.persons||null:null),this.helper.cleanObject(o)},i.prototype.getSerializedOptions=function(t){var e="";t=this.getParsedOptions(t);for(var o in t)if(t.hasOwnProperty(o))if(this.helper.isArray(t[o]))for(var r=0;r<t[o].length;r++)e+="&"+o+"[]="+t[o][r];else if(this.helper.isObject(t[o]))for(var n in t[o])t[o].hasOwnProperty(n)&&(e+="&"+o+"["+n+"]="+t[o][n]);else e+="&"+o+"="+t[o];return"&"===e.charAt(0)&&(e=e.slice(1)),e},i.prototype._getParsedLocationPoint=function(t){return this.helper.isObject(t)?t.hasOwnProperty("lat")&&t.hasOwnProperty("lng")?this.helper.cleanObject({lat:t.lat,lon:t.lng,radius:t.radius,country_code:t.countryCode}):(this.logger.log("Missing required parameters for locationPoint: lat or lng"),null):(this.logger.log("locationPoint is not an Object"),null)},i.prototype._getParsedLocationShape=function(t){return this.helper.isObject(t)?t.hasOwnProperty("topRight")&&this.helper.isObject(t.topRight)&&t.topRight.hasOwnProperty("lat")&&t.topRight.hasOwnProperty("lng")?t.hasOwnProperty("bottomLeft")&&this.helper.isObject(t.bottomLeft)&&t.bottomLeft.hasOwnProperty("lat")&&t.bottomLeft.hasOwnProperty("lng")?this.helper.cleanObject({top_right:{lat:t.topRight.lat,lon:t.topRight.lng},bottom_left:{lat:t.bottomLeft.lat,lon:t.bottomLeft.lng},country_code:t.countryCode}):(this.logger.log("Invalid value of locationShape.bottomLeft"),null):(this.logger.log("Invalid value of locationShape.topRight"),null):(this.logger.log("locationShape is not an Object"),null)},i.prototype._getParsedArea=function(t){return this.helper.isObject(t)?t.hasOwnProperty("min")||t.hasOwnProperty("max")?t:(this.logger.log("getProperties options: Required at least one property `min` or `max` in options.area"),null):(this.logger.log("getProperties options: options.area is not an Object"),null)},i.prototype._getParsedPrice=function(t,e){return e=e||!1,this.helper.isObject(t)?t.hasOwnProperty("min")||t.hasOwnProperty("max")?t.hasOwnProperty("currency")?e&&!t.hasOwnProperty("period")?(this.logger.log("getProperties options: Missing property `period` in options.price"),null):this.helper.cleanObject(t):(this.logger.log("getProperties options: Missing property `currency` in options.price"),null):(this.logger.log("getProperties options: Required at least one property `min` or `max` in options.price"),null):(this.logger.log("getProperties options: options.price is not an Object"),null)},s.prototype.requestPDF=function(t,e,o,r){this.attempt=0,this.doRequest(t,e,o,r)},s.prototype.doRequest=function(t,e,o,r){return this.attempt>=this.attemptsMax?(this.attempt=0,this.resetTimeout(),void r(!1)):(this.attempt++,void this.connector.readPDF(t,e,o,this.pdfCallback.bind(this,t,e,o,r)))},s.prototype.pdfCallback=function(t,e,o,r,n){if(this.resetTimeout(),n.response){var i=JSON.parse(n.response);if(this.hasPath(i))return this.attempt=0,void r(n)}this.timeoutID=setTimeout(function(){this.doRequest(t,e,o,r)}.bind(this),this.delay)},s.prototype.resetTimeout=function(){this.timeoutID&&(clearTimeout(this.timeoutID),this.timeoutID=void 0)},s.prototype.hasPath=function(t){return!!(t&&t.hasOwnProperty("pdf_path")&&t.pdf_path)}}(window);